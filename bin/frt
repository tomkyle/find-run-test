#!/usr/bin/env php
<?php
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\SingleCommandApplication;
use tomkyle\FindRunTest\SymfonyConsoleWrapper;
use tomkyle\FindRunTest\PhpUnitRunner;

if (isset($_composer_autoload_path)) {
	require $_composer_autoload_path;
	$root_path = dirname(realpath($_composer_autoload_path), 2);
} else {
	$possible_autoloaders = array_map(static fn($rp) => $rp  . '/vendor/autoload.php', [ dirname(__DIR__, 4), dirname(__DIR__,2), dirname(__DIR__)]);
	$existing_autoloaders = array_filter($possible_autoloaders, static fn($rp) => is_file($rp));
	if (empty($existing_autoloaders)) {
		fwrite(STDERR, "Could not locate autoloader.\n");
		exit(1);
	}
	$autoload = current($existing_autoloaders);
	require $autoload;
	$root_path = dirname($autoload, 2);
}

$tests_dir = $root_path . '/tests';

(new SingleCommandApplication())
->addArgument('file', InputArgument::REQUIRED, 'The PHP class file to test')
->addOption('config', 'c', InputOption::VALUE_REQUIRED, 'The PhpUnit configuration file to use')
->setCode( new SymfonyConsoleWrapper(new PhpUnitRunner(tests: $tests_dir)))
->run();

